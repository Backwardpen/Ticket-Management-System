<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Management System</title>
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/theme.css">
</head>

<body>
    <header>
        <h1>Ticket Management System</h1>
    </header>

    <div class="container">
        <!-- Link Seite für das Login-form -->
        <div class="left-side">
            <h2>Login ins Dashboard</h2>
            <form id="loginForm">
                <label for="loginEmail">Email:</label>
                <input type="email" id="loginEmail" name="email" placeholder="Beispiel@mail.com" autocomplete="on" required>

                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" name="password" placeholder="Geben Sie ihr Passwort ein" autocomplete="on" required>
                <button type="submit" class="ticket-button">Anmelden</button>
            </form>
            <br>
            <button id="registerButton" class="ticket-button">Registrieren</button>
            <div id="loginStatus" class="form-status" style="display: none;"></div>
        </div>

        <!-- Rechte Seite für das Ticket Management -->
        <div class="right-side">
            <div class="text-align">
                <h2 class="h2_besonders">Tickets</h2>
            </div>
            <button onclick="createTicket()" class="ticket-button">Erstelle ein Ticket</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>© 2024 Ticket System von Jonas Niggemann</p>
    </footer>

    <script>
        const loginStatusDiv = document.getElementById('loginStatus');

        function createTicket() {
            window.location.href = "createTicket.html";
        }

        // Event Listener für Register Button
        document.getElementById('registerButton').addEventListener('click', async function () {
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            const email = emailInput.value;
            const password = passwordInput.value;

            loginStatusDiv.style.display = "none";
            loginStatusDiv.textContent = "";

            const registerData = {
                email: email,
                password: password
            }

            try {
                const response =  await fetch("http://127.0.0.1:5555/register", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(registerData)
                });
                if (response.ok) {
                    const result =  await response.json();
                    console.log('Response Json:', result);
                    loginStatusDiv.textContent = 'Registrierung war erfolgreich!\n'
                    loginStatusDiv.style.display = "block";
                } else {
                    const result = await response.json();
                    console.error("Fehler bei der Registrierung: ", result)
                    loginStatusDiv.textContent = 'Fehler bei der Registrierung:\n' + (result.message || 'Unbekannter Fehler');
                    loginStatusDiv.style.display = "block";
                }
            } catch(error) {
                console.error("Fehler: ", error)
                loginStatusDiv.textContent = 'Ein Fehler beim Registrieren ist aufgetreten: \n' + (error.message || 'Unbekannter Fehler');
                loginStatusDiv.style.display = "block";
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            const  loginStatusDiv = document.getElementById('loginStatus');
            const email = emailInput.value;
            const password = passwordInput.value;
            
            loginStatusDiv.style.display = "none";
            loginStatusDiv.textContent = "";
            
            const   loginData = {
                email: email,
                password: password
            }
    
            try {
                const response =  await fetch("http://127.0.0.1:5555/login", {
                    method: "POST",
                    headers: {
                       'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData)
                });

                if (response.ok) {

                    try {
                        const token =  await response.json();
                        console.log('Response JSON', token);
              
                        if(typeof(token) === 'string' ) { // JWT Decodierung wenn er ein Token  ist (falls die backend api anders liefert, dass hier die anpassungen gemacht werden können)
                            const base64Url = token.split('.')[1]; // header.payload.signature
                            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            }).join('')); // Decodierung mit utf-8 struktur (atob gibt sonst error bei speziellen symbole. Der urlencoded format ist auch in den string kodiert, was in einer anderen encoding zu "not a valid structure" error liefern könnte, was das decode fehlschlagen lassen könnte). Da diese Format eine Url formatiert ist werden spezielle character noch mals encoded in URL, das durch decodieren (uri) wieder korrigiert wird, um wieder einen korrekt formatierten String zu geben)
                            let decodedPayload;

                            try{
                                decodedPayload = JSON.parse(jsonPayload)
                                console.log("decoded Token", decodedPayload)
                            } catch (e) {
                                console.error('Could not decode, its not a correct token JSON. Output will be: ' ,jsonPayload )
                                localStorage.setItem('userEmail',token) // Token ohne struktur als output 
                            }
                            localStorage.setItem('userEmail', decodedPayload.email  || token)
                        } else {
                         localStorage.setItem('userEmail',token.email)   // normale json dekodierung wie er eigentlich ankommen soll
                        }
                        window.location.href = "dashboard.html";
                    } catch (jsonError) {
                        console.error("Fehler beim Lesen der JSON Daten nach login : ", jsonError);
                        loginStatusDiv.textContent = 'Fehler bei Login-Auswertung:\n'+ (jsonError.message || 'Unbekannter Fehler');
                        loginStatusDiv.style.display = "block";
                    }
                } else {   // Wenn der response code NOT OK. (also fehlerhafter login etc. wird versucht)
                    try {
                        const result = await response.json();
                        console.error("Fehler beim Anmelden: ", result);
                        loginStatusDiv.textContent = 'Fehler beim Anmelden:\n' + (result.message || 'Unbekannter Fehler');
                        loginStatusDiv.style.display = "block";
                    } catch (error) { // kein valid json
                        console.error("Fehler beim Auslesen der Daten vom Response", error);
                        loginStatusDiv.textContent = 'Fehler bei der Response\n';
                        loginStatusDiv.style.display = "block";
                    }
                }
            } catch (error) {
                console.error("Fehler beim Anmelden: ", error)
                loginStatusDiv.textContent = 'Ein Fehler beim Login ist aufgetreten:\n' + (error.message || 'Unbekannter Fehler');
                loginStatusDiv.style.display = "block";
            }
        });
    </script>
    
</body>
</html>